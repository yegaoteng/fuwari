---
// src/components/widget/VisitorInfo.astro
// è®¿å®¢ä¿¡æ¯æ˜¾ç¤ºç»„ä»¶
import WidgetLayout from "./WidgetLayout.astro";

interface Props {
	class?: string;
	style?: string;
}

const className = Astro.props.class;
const style = Astro.props.style;
---

<WidgetLayout name="è®¿å®¢ä¿¡æ¯" id="visitor-info" class={className} style={style}>
    <!-- æ¬¢è¿ä¿¡æ¯å— -->
    <div class="welcome-message">
        <p>æ¬¢è¿æ¥åˆ°æˆ‘çš„åšå®¢ï¼æˆ‘æ˜¯ä¸€å Unity å¼€å‘è€…ï¼Œæ¬¢è¿ä½ ä¸æˆ‘äº¤æµçŸ¥è¯†ğŸ’¡ï¼Œæˆ‘ä»¬å…±åŒè¿›æ­¥ ğŸš€</p>
    </div>

    <!-- ä¿¡æ¯å†…å®¹ -->
    <div class="visitor-content">
        <div class="info-item">
            <span class="icon-wrapper icon-ip">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12.5a3.5 3.5 0 1 0 0-7a3.5 3.5 0 0 0 0 7M10.5 14h3a5.5 5.5 0 0 1 5.5 5.5v1h-14v-1A5.5 5.5 0 0 1 10.5 14M2 12c0 5.523 4.477 10 10 10s10-4.477 10-10S17.523 2 12 2S2 6.477 2 12"></path></svg>
            </span>
            <span class="info-label">IP åœ°å€:</span>
            <span id="ip-address" class="info-value">æ­£åœ¨åŠ è½½...</span>
        </div>
        <div class="info-item">
            <span class="icon-wrapper icon-location">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M12 11.5A2.5 2.5 0 0 1 9.5 9A2.5 2.5 0 0 1 12 6.5A2.5 2.5 0 0 1 14.5 9a2.5 2.5 0 0 1-2.5 2.5M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7"></path></svg>
            </span>
            <span class="info-label">åœ°ç†ä½ç½®:</span>
            <span id="location" class="info-value">æ­£åœ¨åŠ è½½...</span>
        </div>
        <div class="info-item">
            <span class="icon-wrapper icon-distance">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="19" r="3"/><path d="M10.4 16.38L15 10l-2.42-2.42"/></svg>
            </span>
            <span class="info-label">ä¸åšä¸»è·ç¦»:</span>
            <span id="distance" class="info-value">æ­£åœ¨è®¡ç®—...</span>
        </div>
        <div class="info-item">
            <span class="icon-wrapper icon-isp">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"></path></svg>
            </span>
            <span class="info-label">è¿ è¥ å•†:</span>
            <span id="isp" class="info-value">æ­£åœ¨åŠ è½½...</span>
        </div>
        <div class="info-item">
            <span class="icon-wrapper icon-os">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M2 6v12h20V6zm18 10H4V8h16z"></path></svg>
            </span>
            <span class="info-label">æ“ä½œç³»ç»Ÿ:</span>
            <span id="os" class="info-value">æ­£åœ¨åŠ è½½...</span>
        </div>
        <div class="info-item">
            <span class="icon-wrapper icon-browser">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10a10 10 0 0 0 10-10A10 10 0 0 0 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8m-4-8a4 4 0 0 1 4-4a4 4 0 0 1 4 4a4 4 0 0 1-4 4a4 4 0 0 1-4-4Z"></path></svg>
            </span>
            <span class="info-label">æµ è§ˆ å™¨:</span>
            <span id="browser" class="info-value">æ­£åœ¨åŠ è½½...</span>
        </div>
        <div class="info-item">
            <span class="icon-wrapper icon-node">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93c0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41c0 2.08-.8 3.97-2.1 5.39z"></path></svg>
            </span>
            <span class="info-label">CDN èŠ‚ç‚¹:</span>
            <img id="cdn-node" class="cdn-logo" alt="Detecting..." />
        </div>
    </div>

    <!-- IP çº¯å‡€åº¦æ£€æµ‹åŒºåŸŸ -->
    <div class="ip-purity-section">
        <button id="ip-purity-btn" class="purity-check-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/>
                <path d="m9 12 2 2 4-4"/>
            </svg>
            <span>æŸ¥çœ‹ IP ä¿¡æ¯å¡</span>
        </button>
        <div id="ip-purity-result" class="purity-result hidden">
            <a href="https://ippure.com" target="_blank" rel="noopener noreferrer" class="ippure-card-link">
                <img id="ippure-card-img" data-src="https://my.ippure.com/v1/card" alt="IPä¿¡æ¯å¡ç‰‡" class="ippure-card-img" />
            </a>
        </div>
    </div>
</WidgetLayout>

<style>
    .welcome-message {
        padding-bottom: 0.75rem;
        margin-bottom: 0.75rem;
        border-bottom: 1px dashed rgba(255, 255, 255, 0.15);
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.9);
    }
    .welcome-message p {
        margin: 0;
        line-height: 1.6;
    }
    .visitor-content {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
    }
    .info-item {
        display: flex;
        align-items: center;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.8);
    }
    /* å›¾æ ‡å®¹å™¨ - ç®€çº¦åœ†å½¢ */
    .icon-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        margin-right: 0.5rem;
        flex-shrink: 0;
        background: rgba(255, 255, 255, 0.08);
        transition: background 0.2s ease;
    }
    .icon-wrapper:hover {
        background: rgba(255, 255, 255, 0.15);
    }
    /* æ¯ä¸ªå›¾æ ‡ä½¿ç”¨ä¸åŒçš„æŸ”å’Œé¢œè‰² */
    .icon-ip svg { color: #a78bfa; }
    .icon-location svg { color: #f472b6; }
    .icon-distance svg { color: #67e8f9; }
    .icon-isp svg { color: #6ee7b7; }
    .icon-os svg { color: #fbbf24; }
    .icon-browser svg { color: #93c5fd; }
    .icon-node svg { color: #c4b5fd; }
    .info-label {
        min-width: 70px;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 500;
    }
    .info-value {
        word-break: break-all;
        overflow-wrap: break-word;
        color: rgba(255, 255, 255, 0.9);
    }
    .cdn-logo {
        height: 26px;
        max-width: 110px;
        width: auto;
        object-fit: contain;
        display: inline-block;
        vertical-align: middle;
        margin-left: 4px;
        transition: transform 0.2s ease;
    }
    .cdn-logo:hover {
        transform: scale(1.05);
    }

    /* IP çº¯å‡€åº¦æ£€æµ‹åŒºåŸŸ */
    .ip-purity-section {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px dashed rgba(255, 255, 255, 0.15);
    }
    .purity-check-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.5rem 1rem;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .purity-check-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.25);
        color: rgba(255, 255, 255, 0.95);
    }
    .purity-check-btn.expanded {
        border-radius: 8px 8px 0 0;
        border-bottom: none;
    }
    .purity-check-btn.loading {
        pointer-events: none;
        opacity: 0.7;
    }
    .purity-result {
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-top: none;
        border-radius: 0 0 8px 8px;
        background: rgba(255, 255, 255, 0.05);
    }
    .purity-result.hidden {
        display: none;
    }
    .ippure-card-link {
        display: block;
    }
    .ippure-card-img {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 0 0 6px 6px;
    }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // åšä¸»ä½ç½®åæ ‡ - ä¸­å›½å±±ä¸œæ³°å®‰
    const BLOGGER_LAT = 36.1928;
    const BLOGGER_LON = 117.1200;

    // CDN èµ„æºè·¯å¾„
    const CDN_IMG_CF = '/cdn/cloudflare.svg';
    const CDN_IMG_EO = '/cdn/edgeone.png';
    const CDN_IMG_VERCEL = '/cdn/vercel.png';


    const checkCDN = async () => {
        const imgEl = document.getElementById('cdn-node') as HTMLImageElement;
        if (!imgEl) return;

        // æœ¬åœ°å¼€å‘ç¯å¢ƒæ£€æµ‹
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        if (isLocalhost) {
            // æœ¬åœ°å¼€å‘æ—¶ï¼Œç”¨æ–‡å­—æ›¿ä»£å›¾ç‰‡
            const textSpan = document.createElement('span');
            textSpan.textContent = 'æœ¬åœ°å¼€å‘';
            textSpan.className = 'info-value';
            textSpan.style.marginLeft = '4px';
            imgEl.replaceWith(textSpan);
            return;
        }

        try {
            // å‘é€ HEAD è¯·æ±‚æ£€æµ‹å“åº”å¤´
            const response = await fetch(window.location.href, { method: 'HEAD' });
            
            // Cloudflare å®˜æ–¹è®¤è¯çš„æ ‡è¯†ç¬¦
            const cfRay = response.headers.get('cf-ray');
            const cfCacheStatus = response.headers.get('cf-cache-status');
            
            // EdgeOne å®˜æ–¹è®¤è¯çš„æ ‡è¯†ç¬¦
            const eoLogUuid = response.headers.get('eo-log-uuid');
            const eoCacheStatus = response.headers.get('eo-cache-status');

            // Vercel å®˜æ–¹è®¤è¯çš„æ ‡è¯†ç¬¦
            const vercelId = response.headers.get('x-vercel-id');
            const vercelCache = response.headers.get('x-vercel-cache');

            if (cfRay || cfCacheStatus) {
                imgEl.src = CDN_IMG_CF;
                imgEl.alt = 'Cloudflare';
            } else if (eoLogUuid || eoCacheStatus) {
                imgEl.src = CDN_IMG_EO;
                imgEl.alt = 'EdgeOne';
            } else if (vercelId || vercelCache) {
                imgEl.src = CDN_IMG_VERCEL;
                imgEl.alt = 'Vercel';
                imgEl.style.height = '14px';
                imgEl.style.width = 'auto';
            } else {
                imgEl.style.display = 'none';
                imgEl.alt = 'Unknown CDN';
            }
        } catch (e) {
            console.error('CDN detection failed:', e);
            imgEl.style.display = 'none';
        }
    };

    const calculateDistance = (lat1: number, lon1: number, lat2: number, lon2: number) => {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 0.5 - Math.cos(dLat) / 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * (1 - Math.cos(dLon)) / 2;
        return Math.round(R * 2 * Math.asin(Math.sqrt(a)));
    };

    const getOS = () => {
      const ua = navigator.userAgent;
      if (ua.includes('Win')) return 'Windows';
      if (ua.includes('Mac')) return 'MacOS';
      if (ua.includes('Linux')) return 'Linux';
      if (ua.includes('Android')) return 'Android';
      if (ua.includes('like Mac')) return 'iOS';
      return 'Unknown';
    };

    const getBrowser = () => {
      const ua = navigator.userAgent;
      if (ua.includes('Chrome') && !ua.includes('Edg')) return 'Chrome';
      if (ua.includes('Safari') && !ua.includes('Chrome')) return 'Safari';
      if (ua.includes('Firefox')) return 'Firefox';
      if (ua.includes('Edg')) return 'Edge';
      return 'Unknown';
    };
    
    const setInfo = (id: string, text: string) => {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
    };
    
    const setAllToFailure = () => {
        setInfo('ip-address', 'è·å–å¤±è´¥');
        setInfo('location', 'è·å–å¤±è´¥');
        setInfo('isp', 'è·å–å¤±è´¥');
        setInfo('distance', 'è·å–å¤±è´¥');
    };

    interface ParsedData {
        ip?: string;
        location?: string;
        isp?: string;
        lat?: number;
        lon?: number;
    }

    interface ApiEndpoint {
        name: string;
        url: string;
        parser: (data: any) => ParsedData | null;
    }

    const apiEndpoints: ApiEndpoint[] = [
        { 
            name: 'ip.sb', 
            url: 'https://api.ip.sb/geoip', 
            parser: (data: any) => ({ 
                ip: data.ip, 
                location: `${data.country || ''}, ${data.city || ''}`, 
                isp: data.organization, 
                lat: data.latitude, 
                lon: data.longitude 
            }) 
        },
        { 
            name: 'ipinfo.io', 
            url: 'https://ipinfo.io/json', 
            parser: (data: any) => {
                const [lat, lon] = data.loc ? data.loc.split(',') : [null, null];
                return { 
                    ip: data.ip, 
                    location: `${data.country || ''}, ${data.city || ''}`, 
                    isp: data.org, 
                    lat: parseFloat(lat), 
                    lon: parseFloat(lon) 
                };
            }
        },
        {
            name: 'api.vore.top',
            url: 'https://api.vore.top/api/IPdata',
            parser: (data: any) => {
                if(data.code !== 200 || !data.ipinfo) return null;
                return { 
                    ip: data.ipinfo.ip, 
                    location: `${data.ipinfo.info.country || ''}, ${data.ipinfo.info.province || ''}, ${data.ipinfo.info.city || ''}`.replace(/, $/, ''), 
                    isp: data.ipinfo.info.isp, 
                    lat: data.ipinfo.adcode?.lat, 
                    lon: data.ipinfo.adcode?.lng 
                }
            }
        },
        {
            name: 'ipwho.is',
            url: 'https://ipwho.is/',
            parser: (data: any) => {
                if (!data.success) return null;
                return { 
                    ip: data.ip, 
                    location: `${data.country || ''}, ${data.city || ''}`, 
                    isp: data.isp, 
                    lat: data.latitude, 
                    lon: data.longitude 
                }
            }
        },
        { 
            name: 'freegeoip.app', 
            url: 'https://freegeoip.app/json/', 
            parser: (data: any) => ({ 
                ip: data.ip, 
                location: `${data.country_name || ''}, ${data.city || ''}`, 
                isp: '', 
                lat: data.latitude, 
                lon: data.longitude 
            }) 
        },
        { 
            name: 'ipapi.co', 
            url: 'https://ipapi.co/json/', 
            parser: (data: any) => ({ 
                ip: data.ip, 
                location: `${data.country_name || ''}, ${data.city || ''}`, 
                isp: data.org, 
                lat: data.latitude, 
                lon: data.longitude 
            }) 
        },
        { 
            name: 'vvhan.com', 
            url: 'https://api.vvhan.com/api/ipInfo?type=json', 
            parser: (data: any) => data.success ? { 
                ip: data.ip, 
                location: `${data.info.country || ''}, ${data.info.city || ''}`, 
                isp: data.info.isp 
            } : null 
        },
        { 
            name: 'ip-api.com', 
            url: 'https://ip-api.com/json', 
            parser: (data: any) => data.status === 'success' ? { 
                ip: data.query, 
                location: `${data.country || ''}, ${data.city || ''}`, 
                isp: data.isp, 
                lat: data.lat, 
                lon: data.lon 
            } : null 
        }
    ];

    const fetchIpInfo = async () => {
        setInfo('os', getOS());
        setInfo('browser', getBrowser());
        // å¯åŠ¨ CDN æ£€æµ‹
        checkCDN();

        let finalData: ParsedData = {};

        for (const api of apiEndpoints) {
            if (finalData.lat && finalData.lon) break;
            
            try {
                const response = await fetch(api.url);
                if (!response.ok) throw new Error(`Response not OK for ${api.name}`);
                const data = await response.json();
                const parsed = api.parser(data);
                if (parsed) {
                    finalData = { ...finalData, ...parsed };
                }
            } catch (error) {
                console.error(`Error from ${api.name}:`, error);
            }
        }

        if (finalData.ip && !finalData.lat) {
            console.log(`Have IP (${finalData.ip}) but no coordinates. Trying final lookup.`);
            try {
                const response = await fetch(`https://ip-api.com/json/${finalData.ip}`);
                if (!response.ok) throw new Error('Final lookup failed');
                const data = await response.json();
                if (data.status === 'success') {
                    finalData.lat = data.lat;
                    finalData.lon = data.lon;
                }
            } catch (error) {
                console.error('Error during final coordinate lookup:', error);
            }
        }

        if (finalData.ip) {
            setInfo('ip-address', finalData.ip);
            setInfo('location', finalData.location || 'N/A');
            setInfo('isp', finalData.isp || 'N/A');
            
            if (finalData.lat && finalData.lon) {
                const dist = calculateDistance(BLOGGER_LAT, BLOGGER_LON, finalData.lat, finalData.lon);
                setInfo('distance', `çº¦ ${dist} å…¬é‡Œ`);
            } else {
                setInfo('distance', 'æ— æ³•è®¡ç®—');
            }
        } else {
            setAllToFailure();
        }
    };

    fetchIpInfo();

    // IP ä¿¡æ¯å¡ç‰‡åˆ‡æ¢æ˜¾ç¤º
    const setupPurityCheck = () => {
        const btn = document.getElementById('ip-purity-btn') as HTMLButtonElement | null;
        const resultDiv = document.getElementById('ip-purity-result');
        const cardImg = document.getElementById('ippure-card-img') as HTMLImageElement | null;
        if (!btn || !resultDiv || !cardImg) return;

        const baseSrc = cardImg.dataset.src || 'https://my.ippure.com/v1/card';
        let isExpanded = false;

        // å›¾ç‰‡åŠ è½½å®Œæˆäº‹ä»¶
        cardImg.addEventListener('load', () => {
            btn.classList.remove('loading');
            const btnSpan = btn.querySelector('span');
            if (btnSpan && isExpanded) btnSpan.textContent = 'æ”¶èµ· IP ä¿¡æ¯å¡';
        });

        // å›¾ç‰‡åŠ è½½å¤±è´¥äº‹ä»¶
        cardImg.addEventListener('error', () => {
            btn.classList.remove('loading');
            const btnSpan = btn.querySelector('span');
            if (btnSpan) btnSpan.textContent = 'åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•';
            isExpanded = false;
            resultDiv.classList.add('hidden');
            btn.classList.remove('expanded');
        });

        btn.addEventListener('click', () => {
            if (btn.classList.contains('loading')) return; // åŠ è½½ä¸­ç¦æ­¢ç‚¹å‡»
            
            isExpanded = !isExpanded;
            
            if (isExpanded) {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                btn.classList.add('loading');
                const btnSpan = btn.querySelector('span');
                if (btnSpan) btnSpan.textContent = 'æŸ¥è¯¢ä¸­...';
                
                // æ¯æ¬¡å±•å¼€æ—¶åŠ è½½æ–°å›¾ç‰‡ï¼ˆæ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜ï¼‰
                cardImg.src = `${baseSrc}?t=${Date.now()}`;
                resultDiv.classList.remove('hidden');
                btn.classList.add('expanded');
            } else {
                resultDiv.classList.add('hidden');
                btn.classList.remove('expanded');
                const btnSpan = btn.querySelector('span');
                if (btnSpan) btnSpan.textContent = 'æŸ¥çœ‹ IP ä¿¡æ¯å¡';
            }
        });
    };

    setupPurityCheck();
  });
</script>
