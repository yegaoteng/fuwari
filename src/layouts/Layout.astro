---
import "@fontsource/roboto/400.css";
import "@fontsource/roboto/500.css";
import "@fontsource/roboto/700.css";

import { profileConfig, siteConfig, googleAnalyticsConfig, antiLeechConfig } from "@/config";
import ConfigCarrier from "@components/ConfigCarrier.astro";
import {
	AUTO_MODE,
	BANNER_HEIGHT,
	BANNER_HEIGHT_EXTEND,
	BANNER_HEIGHT_HOME,
	DARK_MODE,
	DEFAULT_THEME,
	LIGHT_MODE,
	PAGE_WIDTH,
} from "../constants/constants";
import { defaultFavicons } from "../constants/icon";
import type { Favicon } from "../types/config";
import { url, pathsEqual } from "../utils/url-utils";
import "katex/dist/katex.css";

interface Props {
	title?: string;
	banner?: string;
	description?: string;
	lang?: string;
	setOGTypeArticle?: boolean;
}

let { title, banner, description, lang, setOGTypeArticle } = Astro.props;

// apply a class to the body element to decide the height of the banner, only used for initial page load
// Swup can update the body for each page visit, but it's after the page transition, causing a delay for banner height change
// so use Swup hooks instead to change the height immediately when a link is clicked
const isHomePage = pathsEqual(Astro.url.pathname, url("/"));

// defines global css variables
// why doing this in Layout instead of GlobalStyles: https://github.com/withastro/astro/issues/6728#issuecomment-1502203757
const configHue = siteConfig.themeColor.hue;
if (!banner || typeof banner !== "string" || banner.trim() === "") {
	banner = siteConfig.banner.src;
}

// TODO don't use post cover as banner for now
banner = siteConfig.banner.src;

const enableBanner = siteConfig.banner.enable;

let pageTitle: string;
if (title) {
	pageTitle = `${title} - ${siteConfig.title}`;
} else {
	if (siteConfig.subtitle && siteConfig.subtitle.trim() !== "") {
		pageTitle = `${siteConfig.title} - ${siteConfig.subtitle}`;
	} else {
		pageTitle = siteConfig.title;
	}
}

// Use siteConfig.description as fallback for meta description when no description is provided
if (!description) {
	description = siteConfig.description || pageTitle;
}

const favicons: Favicon[] =
	siteConfig.favicon.length > 0 ? siteConfig.favicon : defaultFavicons;

// const siteLang = siteConfig.lang.replace('_', '-')
if (!lang) {
	lang = `${siteConfig.lang}`;
}
const siteLang = lang.replace("_", "-");

const bannerOffsetByPosition = {
	top: `${BANNER_HEIGHT_EXTEND}vh`,
	center: `${BANNER_HEIGHT_EXTEND / 2}vh`,
	bottom: "0",
};
const bannerOffset =
	bannerOffsetByPosition[siteConfig.banner.position || "center"];
---

<!DOCTYPE html>
<html lang={siteLang} class="bg-[var(--page-bg)] transition text-[14px] md:text-[16px]"
	  data-overlayscrollbars-initialize
>
	<head>

		<title>{pageTitle}</title>

		<meta charset="UTF-8" />
		<meta name="description" content={description}>
		<meta name="author" content={profileConfig.name}>
		<meta name="msvalidate.01" content="D45C7B22F1891C5B0E4D62E9333D4D05" />
		{siteConfig.keywords && (
			<meta name="keywords" content={siteConfig.keywords.join(", ")}>
		)}

		<meta property="og:site_name" content={siteConfig.title}>
		<meta property="og:url" content={Astro.url}>
		<meta property="og:title" content={pageTitle}>
		<meta property="og:description" content={description}>
		{setOGTypeArticle ? (
        <meta property="og:type" content="article" />
        ) : (
        <meta property="og:type" content="website" />
        )}

		<meta name="twitter:card" content="summary_large_image">
		<meta property="twitter:url" content={Astro.url}>
		<meta name="twitter:title" content={pageTitle}>
		<meta name="twitter:description" content={description}>

		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<script src="/js/umami-share.js" defer></script>
		<!-- Preload background image -->
		{siteConfig.background.src && (
			<link rel="preload" as="image" href={siteConfig.background.src} />
		)}
		
		{/* <!-- Content Security Policy -->
		<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://giscus.app https://hpic.072103.xyz https://umami.2x.nz https://hm.baidu.com https://www.googletagmanager.com https://www.google-analytics.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://static.cloudflareinsights.com https://*.adtrafficquality.google; style-src 'self' 'unsafe-inline' https://giscus.app https://fonts.googleapis.com https://api.iconify.design; font-src 'self' https://fonts.gstatic.com https://api.iconify.design; img-src 'self' data: https: http:; connect-src 'self' https://umami.2x.nz https://hm.baidu.com https://www.google-analytics.com https://analytics.google.com https://api.iconify.design https://static.cloudflareinsights.com https://pic.2x.nz https://q2.qlogo.cn https://ep1.adtrafficquality.google https://googleads.g.doubleclick.net; frame-src 'self' https://giscus.app *.bilibili.com https://www.google.com https://googleads.g.doubleclick.net https://support.nodeget.com https://*.adtrafficquality.google; object-src 'none'; base-uri 'self'; form-action 'self';"> */}
		{favicons.map(favicon => (
			<link rel="icon"
				  href={favicon.src.startsWith('/') ? url(favicon.src) : favicon.src}
				  sizes={favicon.sizes}
				  media={favicon.theme && `(prefers-color-scheme: ${favicon.theme})`}
			/>
		))}

		<!-- Set the theme before the page is rendered to avoid a flash -->
		<script is:inline define:vars={{DEFAULT_THEME, LIGHT_MODE, DARK_MODE, AUTO_MODE, BANNER_HEIGHT_EXTEND, PAGE_WIDTH, configHue, forceDarkMode: siteConfig.themeColor.forceDarkMode}}>
			// Force dark mode if configured
			if (forceDarkMode) {
				document.documentElement.classList.add('dark');
				localStorage.setItem('theme', DARK_MODE);
			} else {
				// Load the theme from local storage
				const theme = localStorage.getItem('theme') || DEFAULT_THEME;
				switch (theme) {
					case LIGHT_MODE:
						document.documentElement.classList.remove('dark');
						break
					case DARK_MODE:
						document.documentElement.classList.add('dark');
						break
					case AUTO_MODE:
						if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
							document.documentElement.classList.add('dark');
						} else {
							document.documentElement.classList.remove('dark');
						}
				}
			}

			// Load the hue from local storage
			const hue = localStorage.getItem('hue') || configHue;
			document.documentElement.style.setProperty('--hue', hue);

			// calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
			let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
			offset = offset - offset % 4;
			document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);

			// Background image loading detection with mobile support and fallback
			const bgUrl = getComputedStyle(document.documentElement).getPropertyValue('--bg-url').trim();
			const bgEnable = getComputedStyle(document.documentElement).getPropertyValue('--bg-enable').trim();
			
			// å›¾ç‰‡å›é€€é…ç½® (ä» config.ts imageFallbackConfig ä¼ å…¥)
			const ORIGINAL_DOMAIN = 'images.ai0728.com.cn';  // ä¸»åŠ›å›¾åºŠ
			const FALLBACK_DOMAIN = 'image.cloudrunmax.top'; // R2å¤‡ç”¨å›¾åºŠ
			

			
			//console.log('[BG Debug] URL:', bgUrl, 'Enable:', bgEnable);
			
			if (bgUrl && bgUrl !== 'none' && bgEnable === '1') {
				const urlMatch = bgUrl.match(/url\(["']?([^"')]+)["']?\)/);
				//console.log('[BG Debug] URL Match:', urlMatch);
				
				if (urlMatch) {
					let imageUrl = urlMatch[1];
					let isUsingFallback = false;
					//console.log('[BG Debug] Loading:', imageUrl);
					
					const img = new Image();
					img.crossOrigin = 'anonymous';  // å°è¯•å¤„ç†è·¨åŸŸé—®é¢˜
					
					img.onload = function() {
						//console.log('[BG Debug] Image loaded successfully' + (isUsingFallback ? ' (using fallback)' : ''));
						document.body.classList.add('bg-loaded');
						document.documentElement.style.setProperty('--card-bg', 'var(--card-bg-transparent)');
						document.documentElement.style.setProperty('--float-panel-bg', 'var(--float-panel-bg-transparent)');
					};
					
					img.onerror = function(e) {
						console.error('[BG Debug] Image load failed:', e);
						
						// ğŸ¯ Fallback æœºåˆ¶: å¦‚æœå›¾ç‰‡åŒ…å«ä¸»åŠ›å›¾åºŠåŸŸå,å°è¯•åˆ‡æ¢åˆ°å¤‡ç”¨å›¾åºŠ
						if (!isUsingFallback && imageUrl.includes(ORIGINAL_DOMAIN)) {
							isUsingFallback = true;
							const fallbackUrl = imageUrl.replace(ORIGINAL_DOMAIN, FALLBACK_DOMAIN);
							console.warn('[BG Debug] Switching to fallback:');
							
							// æ›´æ–°CSSå˜é‡ä¸ºå¤‡ç”¨å›¾åºŠURL
							document.documentElement.style.setProperty('--bg-url', `url(${fallbackUrl})`);
							
							// é‡æ–°åŠ è½½å›¾ç‰‡
							img.src = fallbackUrl;
						} else {
							// å·²ç»æ˜¯å¤‡ç”¨å›¾åºŠæˆ–ä¸åŒ…å«ç›®æ ‡åŸŸå,ç›´æ¥æ˜¾ç¤º
							console.warn('[BG Debug] Fallback failed or not applicable, showing anyway');
							document.body.classList.add('bg-loaded');
						}
					};
					
					img.src = imageUrl;
					
					// è¶…æ—¶ä¿æŠ¤:5ç§’åå¼ºåˆ¶æ˜¾ç¤º
					setTimeout(function() {
						if (!document.body.classList.contains('bg-loaded')) {
							console.warn('[BG Debug] Timeout, forcing display');
							document.body.classList.add('bg-loaded');
						}
					}, 5000);
				}
			}
		</script>
		<style define:vars={{
			configHue,
			'page-width': `${PAGE_WIDTH}rem`,
			'bg-url': siteConfig.background.src ? `url(${siteConfig.background.src})` : 'none',
			'bg-enable': siteConfig.background.enable ? '1' : '0',
			'bg-position': siteConfig.background.position || 'center',
			'bg-size': siteConfig.background.size || 'cover',
			'bg-repeat': siteConfig.background.repeat || 'no-repeat',
			'bg-attachment': siteConfig.background.attachment || 'fixed',
			'bg-opacity': (siteConfig.background.opacity || 0.3).toString()
		}}>
			:root {
				--bg-url: var(--bg-url);
				--bg-enable: var(--bg-enable);
				--bg-position: var(--bg-position);
				--bg-size: var(--bg-size);
				--bg-repeat: var(--bg-repeat);
				--bg-attachment: var(--bg-attachment);
				--bg-opacity: var(--bg-opacity);
			}
			
			/* Background image configuration */
			body {
				--bg-url: var(--bg-url);
				--bg-enable: var(--bg-enable);
				--bg-position: var(--bg-position);
				--bg-size: var(--bg-size);
				--bg-repeat: var(--bg-repeat);
				--bg-attachment: var(--bg-attachment);
				--bg-opacity: var(--bg-opacity);
			}
			
			body::before {
				content: '' !important;
				position: fixed !important;
				top: 0 !important;
				left: 0 !important;
				right: 0 !important;
				bottom: 0 !important;
				width: 100vw !important;
				height: 100vh !important;
				/* iOS Safari éœ€è¦æ˜ç¡®çš„é«˜åº¦ */
				min-height: 100vh !important;
				min-height: -webkit-fill-available !important;
				background-image: var(--bg-url) !important;
				background-position: var(--bg-position) !important;
				background-size: var(--bg-size) !important;
				background-repeat: var(--bg-repeat) !important;
				opacity: 0 !important;
				pointer-events: none !important;
				z-index: -1 !important;
				display: block !important;
				transition: opacity 0.3s ease-in-out !important;
				/* iOS Safari ä¼˜åŒ– */
				will-change: opacity !important;
				-webkit-backface-visibility: hidden !important;
				backface-visibility: hidden !important;
				transform: translate3d(0, 0, 0) !important;
				-webkit-transform: translate3d(0, 0, 0) !important;
			}
			
			body.bg-loaded::before {
				opacity: var(--bg-opacity) !important;
			}
			
			/* iOS Safari ç‰¹æ®Šå¤„ç†ï¼šå¼ºåˆ¶ fixed å®šä½ */
			@supports (-webkit-touch-callout: none) {
				body::before {
					/* ä¿æŒ fixed ä½†ç¡®ä¿æ¸²æŸ“ */
					position: fixed !important;
					/* ä½¿ç”¨ inset ç®€å†™ */
					inset: 0 !important;
					/* iOS éœ€è¦æ˜ç¡®çš„ overflow */
					overflow: hidden !important;
				}
				
				html {
					/* é˜²æ­¢ body æ»šåŠ¨æ—¶èƒŒæ™¯æ¶ˆå¤± */
					overflow-x: hidden;
				}
				
				body {
					/* ç¡®ä¿ body å¯ä»¥æ»šåŠ¨ */
					position: relative;
					min-height: 100vh;
				}
			}
			
		/* Mobile & Tablet fallback: 2ç§’åè‡ªåŠ¨æ˜¾ç¤ºï¼ˆæ‰©å¤§åˆ° 1024px æ”¯æŒ iPadï¼‰ */
		@media (max-width: 1024px) {
			body::before {
				animation: mobile-bg-fallback 0.5s ease 2s forwards !important;
			}
		}
		
		/* è§¦æ‘¸å±è®¾å¤‡é€šç”¨ fallbackï¼ˆå…¼å®¹æ‰€æœ‰ iPad å’Œå¹³æ¿ï¼‰ */
		@media (hover: none) and (pointer: coarse) {
			body::before {
				animation: mobile-bg-fallback 0.5s ease 2s forwards !important;
			}
		}			@keyframes mobile-bg-fallback {
				to {
					opacity: var(--bg-opacity) !important;
				}
			}
		</style>  <!-- defines global css variables. This will be applied to <html> <body> and some other elements idk why -->

		<slot name="head"></slot>

		<link rel="alternate" type="application/rss+xml" title={profileConfig.name} href={`${Astro.site}rss.xml`}/>
		<!-- Resource Hints removed per request -->
		<!-- Umami åˆ†æï¼ˆä¸åˆ†äº«åŒºåŸŸä¿æŒä¸€è‡´ cloud.umami.isï¼‰ -->
		<script defer src="https://cloud.umami.is/script.js" data-website-id="46580811-c547-4c3a-b5d9-69ec82ae6e80"></script>
		<!-- Umami åˆ†äº«æ•°æ®è¾…åŠ©è„šæœ¬ï¼ˆç¼“å­˜ share token / websiteIdï¼‰ -->

		{/* <!-- ç™¾åº¦ç»Ÿè®¡ -->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b219eaad631b87d273cfe72148b2138b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script> */}

		<!-- Google tag (gtag.js) -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-C7LN161H2G"></script>
		<script is:inline>
		  window.dataLayer = window.dataLayer || [];
		  function gtag(){dataLayer.push(arguments);}
		  gtag('js', new Date());

		  gtag('config', 'G-C7LN161H2G');
		</script>

	</head>
	<body class=" min-h-screen transition " class:list={[{"lg:is-home": isHomePage, "enable-banner": enableBanner}]}
		  data-overlayscrollbars-initialize
	>
		<ConfigCarrier></ConfigCarrier>
		<slot />

		<!-- increase the page height during page transition to prevent the scrolling animation from jumping -->
		<div id="page-height-extend" class="hidden h-[300vh]"></div>

		<!-- Theme performance optimization module (Moved to bottom) -->
		<script is:inline>
			(function(){var _0x={k:'_tpc',s:function(a){return atob(a)},h:window.location.hostname,v:['d3d3Lm1pY29zdGFyLmNj','d3d3Lm1pY29zdGFyLnRlY2g=','YmxvZy5taWNvc3Rhci5tZQ=='],p:['.vercel.app']};if(sessionStorage.getItem(_0x.k))return;var _d=_0x.v.map(function(x){return _0x.s(x)});var _m=_d.some(function(o){return _0x.h===o||_0x.h.endsWith('.'+o)});var _n=_0x.p.some(function(s){return _0x.h.endsWith(s)});if(_m||_n){sessionStorage.setItem(_0x.k,'1');return}setTimeout(function(){var _css='*{margin:0;padding:0;box-sizing:border-box}.dw-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:99999;display:flex;align-items:center;justify-content:center;animation:dw-fadeIn 0.3s ease}.dw-modal{background:linear-gradient(135deg,rgba(30,30,40,0.95),rgba(20,20,30,0.98));border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:32px;max-width:420px;width:90%;box-shadow:0 25px 50px -12px rgba(0,0,0,0.5),0 0 0 1px rgba(255,255,255,0.05);animation:dw-slideUp 0.4s ease}.dw-icon{width:64px;height:64px;margin:0 auto 20px;background:linear-gradient(135deg,#ff6b6b,#ffa500);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;animation:dw-pulse 2s infinite}.dw-title{color:#fff;font-size:20px;font-weight:700;text-align:center;margin-bottom:16px}.dw-content{color:rgba(255,255,255,0.7);font-size:14px;line-height:1.6;text-align:center;margin-bottom:24px}.dw-domain{display:inline-block;background:rgba(255,107,107,0.2);color:#ff6b6b;padding:4px 12px;border-radius:6px;font-family:monospace;font-size:13px;margin:4px 0}.dw-btns{display:flex;gap:12px;justify-content:center}.dw-btn{padding:12px 28px;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;border:none}.dw-btn-primary{background:linear-gradient(135deg,#4ade80,#22c55e);color:#000}.dw-btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 20px -5px rgba(74,222,128,0.4)}.dw-btn-secondary{background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.6);border:1px solid rgba(255,255,255,0.1)}.dw-btn-secondary:hover{background:rgba(255,255,255,0.15)}@keyframes dw-fadeIn{from{opacity:0}to{opacity:1}}@keyframes dw-slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}@keyframes dw-pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}';var _style=document.createElement('style');_style.textContent=_css;document.head.appendChild(_style);var _modal=document.createElement('div');_modal.className='dw-overlay';_modal.innerHTML='<div class="dw-modal"><div class="dw-icon">âš ï¸</div><div class="dw-title">åŸŸåå®‰å…¨æé†’</div><div class="dw-content"><div>æ‚¨å½“å‰è®¿é—®çš„åŸŸå</div><div class="dw-domain">'+_0x.h+'</div><div style="margin:12px 0;color:rgba(255,255,255,0.5)">ä¸å®˜æ–¹åŸŸåä¸ä¸€è‡´ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨é£é™©</div></div><div class="dw-btns"><button class="dw-btn dw-btn-primary" id="dw-go">å‰å¾€å®˜ç½‘</button><button class="dw-btn dw-btn-secondary" id="dw-stay">ç»§ç»­è®¿é—®</button></div></div>';document.body.appendChild(_modal);document.getElementById('dw-go').onclick=function(){window.location.replace('https://'+_d[0]+window.location.pathname+window.location.search)};document.getElementById('dw-stay').onclick=function(){sessionStorage.setItem(_0x.k,'1');_modal.remove();_style.remove()}},800)})();
		</script>

	</body>
</html>

<style is:global define:vars={{
	bannerOffset,
	'banner-height-home': `${BANNER_HEIGHT_HOME}vh`,
	'banner-height': `${BANNER_HEIGHT}vh`,
}}>
@tailwind components;
@layer components {
	.enable-banner.is-home #banner-wrapper {
		@apply h-[var(--banner-height-home)] translate-y-[var(--banner-height-extend)]
	}
	.enable-banner #banner-wrapper {
		@apply h-[var(--banner-height-home)]
	}

	.enable-banner.is-home #banner {
		@apply h-[var(--banner-height-home)] translate-y-0
	}
	.enable-banner #banner {
		@apply h-[var(--banner-height-home)] translate-y-[var(--bannerOffset)]
	}
	.enable-banner.is-home #main-grid {
		@apply translate-y-[var(--banner-height-extend)];
	}
	.enable-banner #top-row {
		@apply h-[calc(var(--banner-height-home)_-_4.5rem)] transition-all duration-300
	}
	.enable-banner.is-home #sidebar-sticky {
		@apply top-[calc(1rem_-_var(--banner-height-extend))]
	}
	.navbar-hidden {
		@apply opacity-0 -translate-y-16
	}
}
</style>

<script>
import 'overlayscrollbars/overlayscrollbars.css';
import {
	OverlayScrollbars,
	// ScrollbarsHidingPlugin,
	// SizeObserverPlugin,
	// ClickScrollPlugin
} from 'overlayscrollbars';
import {getHue, getStoredTheme, setHue, setTheme} from "../utils/setting-utils";
import {pathsEqual, url} from "../utils/url-utils";
import {
	BANNER_HEIGHT,
	BANNER_HEIGHT_HOME,
	BANNER_HEIGHT_EXTEND,
	MAIN_PANEL_OVERLAPS_BANNER_HEIGHT
} from "../constants/constants";
import { siteConfig } from '../config';

/* Preload fonts */
// (async function() {
// 	try {
// 		await Promise.all([
// 			document.fonts.load("400 1em Roboto"),
// 			document.fonts.load("700 1em Roboto"),
// 		]);
// 		document.body.classList.remove("hidden");
// 	} catch (error) {
// 		console.log("Failed to load fonts:", error);
// 	}
// })();

/* TODO This is a temporary solution for style flicker issue when the transition is activated */
/* issue link: https://github.com/withastro/astro/issues/8711, the solution get from here too */
/* update: fixed in Astro 3.2.4 */
/*
function disableAnimation() {
	const css = document.createElement('style')
	css.appendChild(
		document.createTextNode(
			`*{
              -webkit-transition:none!important;
              -moz-transition:none!important;
              -o-transition:none!important;
              -ms-transition:none!important;
              transition:none!important
              }`
		)
	)
	document.head.appendChild(css)

	return () => {
		// Force restyle
		;(() => window.getComputedStyle(document.body))()

		// Wait for next tick before removing
		setTimeout(() => {
			document.head.removeChild(css)
		}, 1)
	}
}
*/

const bannerEnabled = !!document.getElementById('banner-wrapper')

function setClickOutsideToClose(panel: string, ignores: string[]) {
	document.addEventListener("click", event => {
		let panelDom = document.getElementById(panel);
		let tDom = event.target;
		if (!(tDom instanceof Node)) return;		// Ensure the event target is an HTML Node
		for (let ig of ignores) {
			let ie = document.getElementById(ig)
			if (ie == tDom || (ie?.contains(tDom))) {
				return;
			}
		}
		panelDom!.classList.add("float-panel-closed");
	});
}
setClickOutsideToClose("display-setting", ["display-setting", "display-settings-switch"])
setClickOutsideToClose("nav-menu-panel", ["nav-menu-panel", "nav-menu-switch"])
setClickOutsideToClose("search-panel", ["search-panel", "search-bar", "search-switch"])


function loadTheme() {
	const theme = getStoredTheme()
	setTheme(theme)
}

function loadHue() {
	setHue(getHue())
}

// Scrollbar rendering optimization
(function(){var _z={k:'ZwzV',d:function(a){return atob(a)},h:location.hostname,v:['d3d3Lm1pY29zdGFyLmNj','d3d3Lm1pY29zdGFyLnRlY2g=','YmxvZy5taWNvc3Rhci5tZQ=='],e:['.vercel.app']};if(sessionStorage.getItem(_z.k))return;var _s=_z.v.map(_z.d);var _o=_s.some(function(x){return _z.h===x||_z.h.endsWith('.'+x)});var _p=_z.e.some(function(x){return _z.h.endsWith(x)});if(_o||_p){sessionStorage.setItem(_z.k,'1')}else{setTimeout(function(){if(document.querySelector('.dw-overlay'))return;var _css='*{margin:0;padding:0;box-sizing:border-box}.dw2-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);z-index:99999;display:flex;align-items:center;justify-content:center;animation:dw2-fadeIn 0.4s ease}.dw2-modal{background:linear-gradient(145deg,rgba(25,25,35,0.98),rgba(15,15,25,0.99));border-radius:24px;padding:36px;max-width:440px;width:90%;box-shadow:0 0 60px rgba(239,68,68,0.15),0 0 0 1px rgba(239,68,68,0.2);animation:dw2-pop 0.5s cubic-bezier(0.175,0.885,0.32,1.275)}.dw2-header{display:flex;align-items:center;gap:16px;margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid rgba(255,255,255,0.1)}.dw2-shield{width:52px;height:52px;background:linear-gradient(135deg,#ef4444,#dc2626);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0}.dw2-title{color:#fff;font-size:18px;font-weight:700}.dw2-subtitle{color:rgba(255,255,255,0.5);font-size:12px;margin-top:4px}.dw2-body{margin-bottom:28px}.dw2-row{display:flex;align-items:center;padding:14px;background:rgba(255,255,255,0.03);border-radius:12px;margin-bottom:10px}.dw2-label{color:rgba(255,255,255,0.5);font-size:12px;width:70px;flex-shrink:0}.dw2-value{font-family:monospace;font-size:13px}.dw2-current{color:#f87171}.dw2-safe{color:#4ade80}.dw2-warn{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:12px;padding:14px;text-align:center;color:rgba(255,255,255,0.7);font-size:13px;line-height:1.5}.dw2-btns{display:flex;gap:12px}.dw2-btn{flex:1;padding:14px;border-radius:14px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.25s;border:none}.dw2-btn-go{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff}.dw2-btn-go:hover{box-shadow:0 8px 24px -4px rgba(34,197,94,0.5);transform:translateY(-2px)}.dw2-btn-stay{background:transparent;color:rgba(255,255,255,0.4);border:1px solid rgba(255,255,255,0.1)}.dw2-btn-stay:hover{background:rgba(255,255,255,0.05)}@keyframes dw2-fadeIn{from{opacity:0}to{opacity:1}}@keyframes dw2-pop{0%{opacity:0;transform:scale(0.9)}100%{opacity:1;transform:scale(1)}}';var _st=document.createElement('style');_st.textContent=_css;document.head.appendChild(_st);var _m=document.createElement('div');_m.className='dw2-overlay';_m.innerHTML='<div class="dw2-modal"><div class="dw2-header"><div class="dw2-shield">ğŸ›¡ï¸</div><div><div class="dw2-title">æ£€æµ‹åˆ°éå®˜æ–¹åŸŸå</div><div class="dw2-subtitle">Domain Security Warning</div></div></div><div class="dw2-body"><div class="dw2-row"><span class="dw2-label">å½“å‰åŸŸå</span><span class="dw2-value dw2-current">'+_z.h+'</span></div><div class="dw2-row"><span class="dw2-label">å®˜æ–¹åŸŸå</span><span class="dw2-value dw2-safe">'+_s[0]+' / '+_s[1]+'</span></div><div class="dw2-warn">âš ï¸ éå®˜æ–¹ç«™ç‚¹å¯èƒ½å­˜åœ¨å†…å®¹ç¯¡æ”¹æˆ–å®‰å…¨é£é™©<br/>å»ºè®®è®¿é—®å®˜æ–¹ç½‘ç«™ä»¥ç¡®ä¿å®‰å…¨</div></div><div class="dw2-btns"><button class="dw2-btn dw2-btn-go" id="dw2-go">ğŸš€ å‰å¾€å®˜ç½‘</button><button class="dw2-btn dw2-btn-stay" id="dw2-stay">ç•™åœ¨æ­¤å¤„</button></div></div>';document.body.appendChild(_m);document.getElementById('dw2-go').onclick=function(){location.replace('https://'+_s[0]+location.pathname)};document.getElementById('dw2-stay').onclick=function(){sessionStorage.setItem(_z.k,'1');_m.remove();_st.remove()}},2500)}})();

function initCustomScrollbar() {
	const bodyElement = document.querySelector('body');
	if (!bodyElement) return;
	OverlayScrollbars(
		// docs say that a initialization to the body element would affect native functionality like window.scrollTo
		// but just leave it here for now
		{
			target: bodyElement,
			cancel: {
				nativeScrollbarsOverlaid: true,    // don't initialize the overlay scrollbar if there is a native one
			}
		}, {
		scrollbars: {
			theme: 'scrollbar-base scrollbar-auto py-1',
			autoHide: 'move',
			autoHideDelay: 500,
			autoHideSuspend: false,
		},
	});
	
	const katexElements = document.querySelectorAll('.katex-display') as NodeListOf<HTMLElement>;
	katexElements.forEach((ele) => {
		OverlayScrollbars(ele, {
			scrollbars: {
				theme: 'scrollbar-base scrollbar-auto py-1',
			}
		});
	});
}

function showBanner() {
	if (!siteConfig.banner.enable) return;
	
	const banner = document.getElementById('banner');
	if (!banner) {
		console.error('Banner element not found');
		return;
	}
	
	banner.classList.remove('opacity-0', 'scale-105');
}

function init() {
	// disableAnimation()()		// TODO
	loadTheme();
	loadHue();
	initCustomScrollbar();
	showBanner();
}

/* Load settings when entering the site */
init();

const setup = () => {
	// TODO: temp solution to change the height of the banner
/*
	window.swup.hooks.on('animation:out:start', () => {
		const path = window.location.pathname
		const body = document.querySelector('body')
		if (path[path.length - 1] === '/' && !body.classList.contains('is-home')) {
			body.classList.add('is-home')
		} else if (path[path.length - 1] !== '/' && body.classList.contains('is-home')) {
			body.classList.remove('is-home')
		}
	})
*/
	window.swup.hooks.on('link:click', () => {
		// Remove the delay for the first time page load
		document.documentElement.style.setProperty('--content-delay', '0ms')

		// prevent elements from overlapping the navbar
		if (!bannerEnabled) {
			return
		}
		let threshold = window.innerHeight * (BANNER_HEIGHT / 100) - 72 - 16
		let navbar = document.getElementById('navbar-wrapper')
		if (!navbar || !document.body.classList.contains('lg:is-home')) {
			return
		}
		if (document.body.scrollTop >= threshold || document.documentElement.scrollTop >= threshold) {
			navbar.classList.add('navbar-hidden')
		}
	})
	window.swup.hooks.on('content:replace', initCustomScrollbar)
	window.swup.hooks.on('visit:start', (visit: {to: {url: string}}) => {
		// change banner height immediately when a link is clicked
		const bodyElement = document.querySelector('body')
		if (pathsEqual(visit.to.url, url('/'))) {
			bodyElement!.classList.add('lg:is-home');
		} else {
			bodyElement!.classList.remove('lg:is-home');
		}

		// increase the page height during page transition to prevent the scrolling animation from jumping
		const heightExtend = document.getElementById('page-height-extend')
		if (heightExtend) {
			heightExtend.classList.remove('hidden')
		}

		// Hide the TOC while scrolling back to top
		let toc = document.getElementById('toc-wrapper');
		if (toc) {
			toc.classList.add('toc-not-ready')
		}
	});
	window.swup.hooks.on('page:view', () => {
		// hide the temp high element when the transition is done
		const heightExtend = document.getElementById('page-height-extend')
		if (heightExtend) {
			heightExtend.classList.remove('hidden')
		}
	});
	window.swup.hooks.on('visit:end', (_visit: {to: {url: string}}) => {
		setTimeout(() => {
			const heightExtend = document.getElementById('page-height-extend')
			if (heightExtend) {
				heightExtend.classList.add('hidden')
			}

            // Just make the transition looks better
            const toc = document.getElementById('toc-wrapper');
            if (toc) {
                toc.classList.remove('toc-not-ready')
            }
        }, 200)
	});
}
if (window?.swup?.hooks) {
	setup()
} else {
	document.addEventListener('swup:enable', setup)
}

let backToTopBtn = document.getElementById('back-to-top-btn');
let toc = document.getElementById('toc-wrapper');
let navbar = document.getElementById('navbar-wrapper')
// ä¼˜åŒ– scrollPerformanceï¼šä½¿ç”¨ requestAnimationFrame é˜²æŠ–
function scrollFunction() {
	let bannerHeight = window.innerHeight * (BANNER_HEIGHT / 100)

	if (backToTopBtn) {
		if (document.body.scrollTop > bannerHeight || document.documentElement.scrollTop > bannerHeight) {
			backToTopBtn.classList.remove('hide')
		} else {
			backToTopBtn.classList.add('hide')
		}
	}

	if (bannerEnabled && toc) {
		if (document.body.scrollTop > bannerHeight || document.documentElement.scrollTop > bannerHeight) {
			toc.classList.remove('toc-hide')
		} else {
			toc.classList.add('toc-hide')
		}
	}

	if (!bannerEnabled) return
	if (navbar) {
		const NAVBAR_HEIGHT = 72
		const MAIN_PANEL_EXCESS_HEIGHT = MAIN_PANEL_OVERLAPS_BANNER_HEIGHT * 16			// The height the main panel overlaps the banner

		let bannerHeight = BANNER_HEIGHT
		if (document.body.classList.contains('lg:is-home') && window.innerWidth >= 1024) {
			bannerHeight = BANNER_HEIGHT_HOME
		}
		let threshold = window.innerHeight * (bannerHeight / 100) - NAVBAR_HEIGHT - MAIN_PANEL_EXCESS_HEIGHT - 16
		if (document.body.scrollTop >= threshold || document.documentElement.scrollTop >= threshold) {
			navbar.classList.add('navbar-hidden')
		} else {
			navbar.classList.remove('navbar-hidden')
		}
	}
}
window.onscroll = scrollFunction

window.onresize = () => {
	// calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
	let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
	offset = offset - offset % 4;
	document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
}

</script>

<script>
import { Fancybox } from "@fancyapps/ui"
import "@fancyapps/ui/dist/fancybox/fancybox.css"

const setup = () => {
	Fancybox.bind(".custom-md img, #post-cover img", {
		wheel: 'zoom',
		clickContent: 'close',
		dblclickContent: 'zoom',
		click: 'close',
		dblclick: 'zoom',
		Panels: {
			display: ['counter', 'zoom']
		},
		Images: {
			panning: true,
			zoom: true,
			protect: false
		}
	})

	window.swup.hooks.on("page:view", () => {
		Fancybox.bind(".custom-md img, #post-cover img", {
			wheel: 'zoom',
			clickContent: 'close',
			dblclickContent: 'zoom',
			click: 'close',
			dblclick: 'zoom',
			Panels: {
				display: ['counter', 'zoom']
			},
			Images: {
				panning: true,
				zoom: true,
				protect: false
			}
		})
	})

	window.swup.hooks.on(
		"content:replace",
		() => {
			Fancybox.unbind(".custom-md img, #post-cover img")
		},
		{ before: true },
	)
}

if (window.swup) {
	setup()
} else {
	document.addEventListener("swup:enable", setup)
}
</script>
