name: IndexNow Auto Submit

on:
  # å½“æœ‰æ–°çš„æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main ]
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'æäº¤åŸå› '
        required: false
        default: 'Manual submission'

jobs:
  submit-indexnow:
    name: Submit URLs to IndexNow
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9.14.4
        
    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    # æ¢å¤ä¸Šæ¬¡çš„æäº¤è®°å½•ç¼“å­˜
    - name: Restore IndexNow submission cache
      uses: actions/cache/restore@v4
      id: cache-restore
      with:
        path: .indexnow-submitted.json
        key: indexnow-submitted-${{ github.ref_name }}
        restore-keys: |
          indexnow-submitted-

    - name: Show cache status
      run: |
        if [ "${{ steps.cache-restore.outputs.cache-hit }}" == "true" ]; then
          echo "âœ… ç¼“å­˜å‘½ä¸­ï¼Œå·²æ¢å¤ä¸Šæ¬¡æäº¤è®°å½•"
          cat .indexnow-submitted.json | head -20
        else
          echo "â„¹ï¸ æœªæ‰¾åˆ°ç¼“å­˜ï¼Œå°†ä½œä¸ºé¦–æ¬¡æäº¤"
        fi
      
    - name: Build site
      run: pnpm build
      
    - name: Submit to IndexNow (Incremental)
      run: |
        echo "Starting IndexNow incremental submission..."
        if pnpm submit-indexnow-inc; then
          echo "âœ… IndexNow incremental submission successful"
        else
          echo "âŒ IndexNow submission failed, but continuing..."
          exit 0
        fi
      continue-on-error: true

    # ä¿å­˜æ›´æ–°åçš„æäº¤è®°å½•åˆ°ç¼“å­˜
    - name: Save IndexNow submission cache
      uses: actions/cache/save@v4
      if: always()
      with:
        path: .indexnow-submitted.json
        key: indexnow-submitted-${{ github.ref_name }}-${{ github.run_id }}
      
    - name: Report status
      if: always()
      run: |
        echo "IndexNow submission workflow completed"
        if [ -f .indexnow-submitted.json ]; then
          echo "ğŸ“Š å½“å‰æäº¤è®°å½•:"
          cat .indexnow-submitted.json | head -20
        fi